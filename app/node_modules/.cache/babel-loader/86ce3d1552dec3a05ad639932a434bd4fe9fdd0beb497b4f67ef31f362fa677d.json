{"ast":null,"code":"/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\n\nimport { ObliviousSet } from 'oblivious-set';\nimport { fillOptionsWithDefaults } from '../options';\nimport { sleep, randomToken, microSeconds as micro } from '../util';\nexport var microSeconds = micro;\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nexport var type = 'localstorage';\n\n/**\n * copied from crosstab\n * @link https://github.com/tejacques/crosstab/blob/master/src/crosstab.js#L32\n */\nexport function getLocalStorage() {\n  var localStorage;\n  if (typeof window === 'undefined') return null;\n  try {\n    localStorage = window.localStorage;\n    localStorage = window['ie8-eventlistener/storage'] || window.localStorage;\n  } catch (e) {\n    // New versions of Firefox throw a Security exception\n    // if cookies are disabled. See\n    // https://bugzilla.mozilla.org/show_bug.cgi?id=1028153\n  }\n  return localStorage;\n}\nexport function storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n\n/**\n * writes the new message to the storage\n * and fires the storage-event so other readers can find it\n */\nexport function postMessage(channelState, messageJson) {\n  return new Promise(function (res) {\n    sleep().then(function () {\n      var key = storageKey(channelState.channelName);\n      var writeObj = {\n        token: randomToken(),\n        time: new Date().getTime(),\n        data: messageJson,\n        uuid: channelState.uuid\n      };\n      var value = JSON.stringify(writeObj);\n      getLocalStorage().setItem(key, value);\n\n      /**\n       * StorageEvent does not fire the 'storage' event\n       * in the window that changes the state of the local storage.\n       * So we fire it manually\n       */\n      var ev = document.createEvent('Event');\n      ev.initEvent('storage', true, true);\n      ev.key = key;\n      ev.newValue = value;\n      window.dispatchEvent(ev);\n      res();\n    });\n  });\n}\nexport function addStorageEventListener(channelName, fn) {\n  var key = storageKey(channelName);\n  var listener = function listener(ev) {\n    if (ev.key === key) {\n      fn(JSON.parse(ev.newValue));\n    }\n  };\n  window.addEventListener('storage', listener);\n  return listener;\n}\nexport function removeStorageEventListener(listener) {\n  window.removeEventListener('storage', listener);\n}\nexport function create(channelName, options) {\n  options = fillOptionsWithDefaults(options);\n  if (!canBeUsed(options)) {\n    throw new Error('BroadcastChannel: localstorage cannot be used');\n  }\n  var uuid = randomToken();\n\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n  var eMIs = new ObliviousSet(options.localstorage.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs // emittedMessagesIds\n  };\n\n  state.listener = addStorageEventListener(channelName, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n    if (msgObj.uuid === uuid) return; // own message\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n    if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\nexport function close(channelState) {\n  removeStorageEventListener(channelState.listener);\n}\nexport function onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\nexport function canBeUsed(options) {\n  if (!options.support3PC) return false;\n  var ls = getLocalStorage();\n  if (!ls) return false;\n  try {\n    var key = '__broadcastchannel_check';\n    ls.setItem(key, 'works');\n    ls.removeItem(key);\n  } catch (e) {\n    // Safari 10 in private mode will not allow write access to local\n    // storage and fail with a QuotaExceededError. See\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API#Private_Browsing_Incognito_modes\n    return false;\n  }\n  return true;\n}\nexport function averageResponseTime() {\n  var defaultTime = 120;\n  var userAgent = navigator.userAgent.toLowerCase();\n  if (userAgent.includes('safari') && !userAgent.includes('chrome')) {\n    // safari is much slower so this time is higher\n    return defaultTime * 2;\n  }\n  return defaultTime;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};","map":{"version":3,"names":["ObliviousSet","fillOptionsWithDefaults","sleep","randomToken","microSeconds","micro","KEY_PREFIX","type","getLocalStorage","localStorage","window","e","storageKey","channelName","postMessage","channelState","messageJson","Promise","res","then","key","writeObj","token","time","Date","getTime","data","uuid","value","JSON","stringify","setItem","ev","document","createEvent","initEvent","newValue","dispatchEvent","addStorageEventListener","fn","listener","parse","addEventListener","removeStorageEventListener","removeEventListener","create","options","canBeUsed","Error","eMIs","localstorage","removeTimeout","state","msgObj","messagesCallback","has","messagesCallbackTime","add","close","onMessage","support3PC","ls","removeItem","averageResponseTime","defaultTime","userAgent","navigator","toLowerCase","includes"],"sources":["/Users/wuhuan/gif-portal-starter/node_modules/@toruslabs/broadcast-channel/dist/esbrowser/methods/localstorage.js"],"sourcesContent":["/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\n\nimport { ObliviousSet } from 'oblivious-set';\nimport { fillOptionsWithDefaults } from '../options';\nimport { sleep, randomToken, microSeconds as micro } from '../util';\nexport var microSeconds = micro;\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nexport var type = 'localstorage';\n\n/**\n * copied from crosstab\n * @link https://github.com/tejacques/crosstab/blob/master/src/crosstab.js#L32\n */\nexport function getLocalStorage() {\n  var localStorage;\n  if (typeof window === 'undefined') return null;\n  try {\n    localStorage = window.localStorage;\n    localStorage = window['ie8-eventlistener/storage'] || window.localStorage;\n  } catch (e) {\n    // New versions of Firefox throw a Security exception\n    // if cookies are disabled. See\n    // https://bugzilla.mozilla.org/show_bug.cgi?id=1028153\n  }\n  return localStorage;\n}\nexport function storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n\n/**\n * writes the new message to the storage\n * and fires the storage-event so other readers can find it\n */\nexport function postMessage(channelState, messageJson) {\n  return new Promise(function (res) {\n    sleep().then(function () {\n      var key = storageKey(channelState.channelName);\n      var writeObj = {\n        token: randomToken(),\n        time: new Date().getTime(),\n        data: messageJson,\n        uuid: channelState.uuid\n      };\n      var value = JSON.stringify(writeObj);\n      getLocalStorage().setItem(key, value);\n\n      /**\n       * StorageEvent does not fire the 'storage' event\n       * in the window that changes the state of the local storage.\n       * So we fire it manually\n       */\n      var ev = document.createEvent('Event');\n      ev.initEvent('storage', true, true);\n      ev.key = key;\n      ev.newValue = value;\n      window.dispatchEvent(ev);\n      res();\n    });\n  });\n}\nexport function addStorageEventListener(channelName, fn) {\n  var key = storageKey(channelName);\n  var listener = function listener(ev) {\n    if (ev.key === key) {\n      fn(JSON.parse(ev.newValue));\n    }\n  };\n  window.addEventListener('storage', listener);\n  return listener;\n}\nexport function removeStorageEventListener(listener) {\n  window.removeEventListener('storage', listener);\n}\nexport function create(channelName, options) {\n  options = fillOptionsWithDefaults(options);\n  if (!canBeUsed(options)) {\n    throw new Error('BroadcastChannel: localstorage cannot be used');\n  }\n  var uuid = randomToken();\n\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n  var eMIs = new ObliviousSet(options.localstorage.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs // emittedMessagesIds\n  };\n\n  state.listener = addStorageEventListener(channelName, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n    if (msgObj.uuid === uuid) return; // own message\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n    if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\nexport function close(channelState) {\n  removeStorageEventListener(channelState.listener);\n}\nexport function onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\nexport function canBeUsed(options) {\n  if (!options.support3PC) return false;\n  var ls = getLocalStorage();\n  if (!ls) return false;\n  try {\n    var key = '__broadcastchannel_check';\n    ls.setItem(key, 'works');\n    ls.removeItem(key);\n  } catch (e) {\n    // Safari 10 in private mode will not allow write access to local\n    // storage and fail with a QuotaExceededError. See\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API#Private_Browsing_Incognito_modes\n    return false;\n  }\n  return true;\n}\nexport function averageResponseTime() {\n  var defaultTime = 120;\n  var userAgent = navigator.userAgent.toLowerCase();\n  if (userAgent.includes('safari') && !userAgent.includes('chrome')) {\n    // safari is much slower so this time is higher\n    return defaultTime * 2;\n  }\n  return defaultTime;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}